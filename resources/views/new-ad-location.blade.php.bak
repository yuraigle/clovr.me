@extends('layouts.base')

@section('meta')
    <meta name="csrf-token" content="{{ csrf_token() }}">@endsection
@section('title')Post an Ad - @endsection

@section('content')
    <div class="width-850 mb-4">
        <h1 class="text-center">Select a Location</h1>

        <form method="post" class="row">
            <p class="text-center mt-4 mb-2">Enter location details:</p>

            <div class="d-flex">
                <div>
                    <input type="text" name="postcode" id="_postcode" class="form-control" placeholder="Postal Code"/>
                    <span class="invalid-feedback"></span>
                </div>

                <div class="ms-1">
                    <input type="text" name="county" id="_county" class="form-control" placeholder="County"/>
                    <span class="invalid-feedback"></span>
                </div>

                <div class="ms-1">
                    <input type="text" name="town" id="_town" class="form-control" placeholder="Town"/>
                    <span class="invalid-feedback"></span>
                </div>

                <div class="flex-grow-1 ms-1">
                    <input type="text" name="address" id="_address" class="form-control" placeholder="Address"/>
                    <span class="invalid-feedback"></span>
                </div>

                <div class="ms-1">
                    <button class="btn btn-outline-secondary" type="button" onclick="locate1()">
                        <i class="fa-solid fa-location-arrow"></i>
                    </button>
                </div>
            </div>

            <p class="text-center mt-2 mb-2">...or click on the map:</p>

            <div>
                <div id="map"></div>
            </div>

            <div class="text-center mt-4" id="found_msg">
                Is this an accurate location of your home?<br/>
                Drag the marker and point the exact location.
            </div>

            <input type="text" name="lng" id="_lng" value="" />
            <input type="text" name="lat" id="_lat" value="" />

            <div class="d-flex flex-row w-100 mt-2 mb-2">
                <a href="{{ route('new-ad') }}" class="btn btn-secondary me-auto">
                    <i class="fa-solid fa-chevron-left"></i>
                    Back
                </a>
                <button type="button" class="btn btn-primary disabled" id="btn1">
                    Yes, it's the correct location
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </form>
    </div>
@endsection

@section('inline_styles')
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
    <style>
        .width-850 {
            max-width: 850px;
            margin: 0 auto;
        }

        #map {
            height: 500px;
        }

        #found_msg {
            height: 40px;
        }

        #_postcode {
            max-width: 110px;
        }
    </style>
@endsection

@section('inline_scripts')
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
    <script type="text/javascript">
        const elMsg1 = document.getElementById('found_msg');
        const elBtn1 = document.getElementById('btn1');
        const elPostcode = document.getElementById('_postcode');
        const elCounty = document.getElementById('_county');
        const elTown = document.getElementById('_town');
        const elAddress = document.getElementById('_address');
        const elLng = document.getElementById('_lng');
        const elLat = document.getElementById('_lat');

        mapboxgl.accessToken = 'pk.eyJ1IjoieXVyYWlnbGUiLCJhIjoiY2wwZmUzdTNnMHJ5eTNubzZpOXEzNGFrayJ9.vK2h-JCIge6NaEABNtPxvw';
        const marker = new mapboxgl.Marker({draggable: true});

        const map = new mapboxgl.Map({
            style: 'mapbox://styles/mapbox/streets-v11',
            container: 'map',
        });

        map.on('click', function (e) {
            marker.setLngLat(e.lngLat).addTo(map);
            locate2(e.lngLat);
        })

        marker.on('dragend', function (e) {
            locate2(e.target._lngLat);
        })

        function locate1() {
            const query = new URLSearchParams({
                types: 'address',
                country: 'ie',
                region: elCounty.value,
                postcode: elPostcode.value,
                place: elTown.value,
                access_token: mapboxgl.accessToken,
                limit: 1,
            });

            const str = [elPostcode.value, elCounty.value, elTown.value, elAddress.value].join(' ');
            const url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/'
                + encodeURIComponent(str) + '.json?' + query.toString();

            fetch(url)
                .then((res) => res.json())
                .then((data) => {
                    if (data && data.features && data.features.length > 0) {
                        show_res1(data.features[0]);
                    } else {
                        show_res0();
                    }
                });
        }

        function locate2(lngLat) {
            const query = new URLSearchParams({
                types: 'address',
                country: 'ie',
                access_token: mapboxgl.accessToken,
            });
            const url2 = 'https://api.mapbox.com/geocoding/v5/mapbox.places/'
                + lngLat.lng + ',' + lngLat.lat + '.json?' + query.toString();

            fetch(url2)
                .then((res) => res.json())
                .then((data) => {
                    if (data && data.features && data.features.length > 0) {
                        for (let c of data.features[0].context) {
                            if (c.id && c.id.startsWith('postcode.')) {
                                elPostcode.value = c.text;
                            }
                            if (c.id && c.id.startsWith('region.')) {
                                elCounty.value = c.text;
                            }
                            if (c.id && c.id.startsWith('place.')) {
                                elTown.value = c.text;
                            }
                        }
                        elAddress.value = data.features[0].text;
                        elBtn1.classList.remove('disabled');
                        elMsg1.style.visibility = 'visible';
                    }
                });

            elLng.value = lngLat.lng;
            elLat.value = lngLat.lat;
        }

        function show_res0() {
            marker.remove();
            map.jumpTo({center: [-6.25, 53.35], zoom: 11});
            elBtn1.classList.add('disabled');
            elMsg1.style.visibility = 'hidden';
            elLng.value = "";
            elLat.value = "";
        }

        function show_res1(f) {
            marker.setLngLat(f.center).addTo(map);
            map.jumpTo({center: f.center, zoom: 16});
            elBtn1.classList.remove('disabled');
            elMsg1.style.visibility = 'visible';
            elLng.value = f.center[0];
            elLat.value = f.center[1];
        }

        show_res0()
    </script>
@endsection
